# 免登录购买功能使用指南

## 功能概述
用户无需注册账户即可直接购买虚拟商品，系统会生成6位查询码用于后续订单查询和商品下载。

## 功能特点

### 对用户的优势
1. **快速购买**：无需注册流程，直接下单
2. **隐私保护**：不强制收集用户信息
3. **灵活查询**：支持多种方式查询订单
4. **可选绑定**：后续可选择注册账户并关联订单

### 对商家的优势
1. **降低购买门槛**：提高转化率
2. **收集联系方式**：通过邮箱、QQ、微信号保持联系
3. **灵活营销**：可通过联系方式进行后续营销

## 使用流程

### 1. 游客下单流程

**步骤1：浏览商品**
- 访问网站首页
- 无需登录即可浏览所有商品
- 点击"添加到购物车"

**步骤2：进入结算**
- 点击购物车图标查看商品
- 点击"去结算"进入支付页面

**步骤3：填写联系信息**
- 必填：联系邮箱（用于接收订单信息）
- 选填：姓名

**步骤4：启用游客模式**
- 勾选"游客模式（无需注册，凭查询码查询订单）"
- 系统会显示额外的联系方式输入框：
  - QQ号（选填）
  - 微信号（选填）

**步骤5：选择支付方式并完成支付**
- Stripe信用卡支付
- USDT加密货币支付
- 微信支付（预留）
- 支付宝支付（预留）

**步骤6：获取查询码**
- 支付成功后，系统会显示**6位查询码**
- **重要**：请务必保存此查询码！

示例查询码：`AB12CD`

### 2. 订单查询流程

#### 方式1：使用查询码查询

1. 访问"订单查询"页面（导航栏中）
2. 输入订单号（例如：ORD1731346800000ABC123）
3. 勾选"使用查询码查询"
4. 输入6位查询码
5. 点击"查询订单"

#### 方式2：使用邮箱查询

1. 访问"订单查询"页面
2. 输入订单号
3. 输入下单时使用的联系邮箱
4. 点击"查询订单"

### 3. 查看虚拟商品

订单查询成功后，可以查看：
- 订单状态和支付状态
- 虚拟商品内容（激活码、下载链接、文件等）
- 支付信息
- 订单详情

## 订单查询码安全说明

### 查询码特点
- **长度**：6位字符
- **格式**：大写字母和数字组合
- **唯一性**：每个订单唯一
- **有效期**：永久有效

### 安全建议
1. **立即保存**：下单成功后立即截图或复制保存
2. **保密**：查询码等同于订单密码，请勿泄露给他人
3. **多重验证**：即使查询码泄露，还需要订单号才能查询
4. **邮箱备份**：可以使用邮箱作为备用查询方式

### 如果查询码丢失
如果忘记或丢失查询码，可以：
1. 使用"订单号 + 邮箱"方式查询
2. 联系客服提供订单号和身份验证信息

## 游客订单 vs 注册用户订单对比

| 功能 | 游客订单 | 注册用户订单 |
|------|---------|--------------|
| 购买商品 | ✅ | ✅ |
| 查看订单 | ✅（需查询码或邮箱） | ✅（登录后直接查看） |
| 下载商品 | ✅ | ✅ |
| 订单历史 | ❌ | ✅（账户中保存） |
| 购物车同步 | ❌ | ✅（跨设备同步） |
| 优惠券 | ✅ | ✅ |
| 积分奖励 | ❌ | ✅ |
| 会员特权 | ❌ | ✅ |

## 后续注册与订单关联

游客完成购买后，如果希望享受更多功能，可以：

1. **注册账户**：使用下单时的邮箱注册
2. **联系客服**：提供订单号和查询码，申请关联订单
3. **自动关联**：系统会根据邮箱自动关联已有订单（功能开发中）

## 数据库设计

### 订单表字段说明

游客订单相关字段：

```sql
-- orders表
is_guest_order BOOLEAN           -- 是否为游客订单
guest_contact_qq VARCHAR(50)     -- 游客QQ号
guest_contact_wechat VARCHAR(100) -- 游客微信号
order_query_token VARCHAR(100)   -- 订单查询凭证
user_id UUID                     -- 可为NULL（游客订单）
```

### 查询订单的SQL示例

```sql
-- 通过查询码查询
SELECT * FROM orders
WHERE order_number = 'ORD1731346800000ABC123'
  AND order_query_token = 'AB12CD';

-- 通过邮箱查询
SELECT * FROM orders
WHERE order_number = 'ORD1731346800000ABC123'
  AND contact_email = 'user@example.com';
```

## API接口说明

### 创建游客订单
**Endpoint**: `/functions/v1/create-order`

**请求体**:
```json
{
  "cartItems": [
    {"productId": "uuid", "quantity": 1}
  ],
  "contactEmail": "user@example.com",
  "contactName": "张三",
  "notes": "订单备注",
  "isGuestOrder": true,
  "guestContactQQ": "123456789",
  "guestContactWechat": "wechat_id"
}
```

**响应**:
```json
{
  "data": {
    "order": {...},
    "queryToken": "AB12CD",
    "message": "订单创建成功！查询码: AB12CD，请妥善保存以便查询订单"
  }
}
```

### 查询游客订单
**Endpoint**: `/functions/v1/query-guest-order`

**请求体（方式1 - 查询码）**:
```json
{
  "orderNumber": "ORD1731346800000ABC123",
  "queryToken": "AB12CD"
}
```

**请求体（方式2 - 邮箱）**:
```json
{
  "orderNumber": "ORD1731346800000ABC123",
  "contactEmail": "user@example.com"
}
```

**响应**:
```json
{
  "data": {
    "order": {...},
    "payment": {...},
    "deliveries": [...]
  }
}
```

## 前端实现说明

### CheckoutPage组件
- 新增`isGuestOrder`状态
- 新增`guestContactQQ`和`guestContactWechat`输入框
- 显示查询码提示和保存提醒

### GuestOrderQueryPage组件
- 支持两种查询方式的切换
- 显示完整的订单信息和虚拟商品

### Navbar组件
- 为游客用户显示"订单查询"入口
- 为注册用户同时显示"我的订单"和"订单查询"

## 常见问题

**Q: 查询码会过期吗？**
A: 不会，查询码永久有效。

**Q: 如果忘记查询码怎么办？**
A: 可以使用"订单号 + 邮箱"的方式查询，或联系客服。

**Q: 游客订单可以申请退款吗？**
A: 可以，提供订单号和查询码即可处理退款申请。

**Q: 一个邮箱可以下多个游客订单吗？**
A: 可以，每个订单都有独立的查询码。

**Q: 游客模式和正常注册有什么区别？**
A: 游客模式无需注册，但不能享受积分、会员等长期权益。建议后续注册账户。

## 技术实现关键点

1. **订单创建**：`create-order` Edge Function支持`user_id`为NULL
2. **查询码生成**：使用随机字符串生成6位大写字母数字组合
3. **查询验证**：支持双重验证方式（查询码或邮箱）
4. **发货流程**：`deliveries`表的`user_id`字段支持NULL
5. **通知系统**：游客订单同样触发通知，标记为"游客订单"

## 未来优化方向

1. **订单关联**：开发自动关联游客订单到注册账户的功能
2. **批量查询**：支持通过邮箱批量查询所有游客订单
3. **短信验证**：增加手机号验证选项
4. **社交登录**：支持QQ、微信快速登录并关联订单
5. **订单追踪**：为游客提供订单状态邮件通知
